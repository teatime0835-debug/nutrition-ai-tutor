import streamlit as st
from openai import OpenAI
import os
from PIL import Image

# ---------------------------
# í˜ì´ì§€ ì„¤ì •
# ---------------------------
st.set_page_config(
    page_title="ì²­ì†Œë…„ AI ì˜ì–‘ íŠœí„°",
    page_icon="ğŸ±",
    layout="centered"
)

st.title("ğŸ± ì²­ì†Œë…„ AI ì˜ì–‘ íŠœí„°")

st.markdown(
"""
ğŸ“Œ ì´ ì„œë¹„ìŠ¤ëŠ” **êµìœ¡ ëª©ì ì˜ AI ì‹œì—°**ì…ë‹ˆë‹¤.

- ë¶„ì„ ê²°ê³¼ëŠ” **ì‹¤ì œ ì˜ì–‘ì†Œ ì¸¡ì •ì´ ì•„ë‹Œ ì¶”ì •ì¹˜**ì…ë‹ˆë‹¤.
- ì˜ë£ŒÂ·ì˜ì–‘ ìƒë‹´ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
"""
)

st.info("ì˜¤ëŠ˜ ë¨¹ì€ ê¸‰ì‹ ì‚¬ì§„ì„ ì°¸ê³ ë¡œ ì˜¬ë¦¬ê³ , ì‹ë‹¨ì„ ê°„ë‹¨íˆ ì„¤ëª…í•´ ë³´ì„¸ìš”.")

# ---------------------------
# OpenAI ì„¤ì •
# ---------------------------
API_KEY = os.getenv("OPENAI_API_KEY")

if not API_KEY:
    st.warning("âš ï¸ OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    st.stop()

client = OpenAI(api_key=API_KEY)

# ---------------------------
# ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì°¸ê³ ìš©)
# ---------------------------
uploaded_file = st.file_uploader(
    "ğŸ½ï¸ ì˜¤ëŠ˜ ë¨¹ì€ ê¸‰ì‹ ì‚¬ì§„ ì—…ë¡œë“œ (ì„ íƒ)",
    type=["jpg", "jpeg", "png"]
)

if uploaded_file:
    image = Image.open(uploaded_file)
    st.image(image, caption="ì—…ë¡œë“œëœ ê¸‰ì‹ ì‚¬ì§„", width=400)

# ---------------------------
# í…ìŠ¤íŠ¸ ì…ë ¥
# ---------------------------
meal_text = st.text_area(
    "âœï¸ ì˜¤ëŠ˜ ë¨¹ì€ ì‹ë‹¨ì„ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”",
    height=100
)

# ---------------------------
# ë¶„ì„ ë²„íŠ¼
# ---------------------------
if st.button("ğŸš€ ì˜ì–‘ ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±"):
    if not meal_text.strip():
        st.warning("ì‹ë‹¨ ì„¤ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    else:
        with st.spinner("AI ì˜ì–‘ íŠœí„°ê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
            try:
                prompt = f"""
ë„ˆëŠ” ëŒ€í•œë¯¼êµ­ ì²­ì†Œë…„(ë§Œ 12~18ì„¸)ì„ ìœ„í•œ ì‹ìƒí™œ êµìœ¡ ì „ë¬¸ê°€ì´ì ì˜ì–‘ êµì‚¬ì•¼.

ì•„ë˜ ì‹ë‹¨ ì„¤ëª…ì„ ë°”íƒ•ìœ¼ë¡œ
**2020 í•œêµ­ì¸ ì˜ì–‘ì†Œ ì„­ì·¨ê¸°ì¤€**ì„ ì°¸ê³ í•´
êµìœ¡ìš© ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ ì¤˜.

[ì‹ë‹¨ ì„¤ëª…]
{meal_text}

[ì¶œë ¥ í˜•ì‹]
### ğŸ“Š ì˜¤ëŠ˜ì˜ ì‹ë‹¨ ë¶„ì„ ë¦¬í¬íŠ¸
1. ğŸ½ï¸ ì‹ë‹¨ êµ¬ì„± ìš”ì•½
2. ğŸ“ˆ ì£¼ìš” ì˜ì–‘ì†Œ í‰ê°€
3. ğŸ’¡ êµìœ¡ì  í”¼ë“œë°±
4. ğŸ§  ì²­ì†Œë…„ì„ ìœ„í•œ í•œ ì¤„ ì¡°ì–¸

â€» ìˆ˜ì¹˜ëŠ” ì¶”ì •ì¹˜ì´ë©° êµìœ¡ ëª©ì ì„ì„ ë¶„ëª…íˆ ë°í˜€.
"""

                response = client.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[
                        {"role": "system", "content": "ë„ˆëŠ” êµìœ¡ìš© AI ì˜ì–‘ íŠœí„°ì•¼."},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=0.4
                )

                st.markdown("---")
                st.markdown(response.choices[0].message.content)
                st.success("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")

            except Exception as e:
                st.error("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                st.caption(str(e))

st.markdown("---")
st.caption("Â© 2026 ì¸ê³µì§€ëŠ¥ìœµí•©êµìœ¡ í”„ë¡œì íŠ¸")
